---
title: "Raster Data Exercise"
execute:
  eval: false
  echo: false
---

```{r}
#| label: setup
#| include: false
library(sf)
library(terra)
library(dplyr)
library(ggplot2)
```

## Introduction

In this exercise, you will develop a spatial habitat suitability model to identify potential chamois habitats in the Canton of Lucerne. This multi-criteria analysis will combine your knowledge of vector and raster data processing, spatial analysis, and ecological modeling.

### Ecological Background

Chamois (*Rupicapra rupicapra*) are mountain ungulates native to European mountain ranges. Understanding their habitat requirements is crucial for conservation planning. Based on ecological research, chamois have the following habitat requirements:

-   **Home range size**: Approximately 1 km²
-   **Forest cover**: Require sufficient forest within their home range for refuge and thermal protection
-   **Steep terrain**: Need steep areas (\> 30°) where they have physiological advantages over predators
-   **Human disturbance**: Avoid human settlements and heavily trafficked roads

### Analytical Workflow

@fig-process-model shows the complete workflow for this analysis. Study this process model carefully - it will guide you through the entire exercise. The process model is also available as a high-resolution PDF on Moodle.

![Process model for chamois habitat suitability analysis](images/ProcessModel_MCA_Chamois.PNG){#fig-process-model}

::: {.callout-tip}
## Working with the Process Model
Before you begin, take time to understand:

- What input datasets are needed?
- What geoprocessing steps will you perform?
- How do the steps connect to each other?
- What is the final output?
:::

Your task is to implement this workflow using R, combining vector and raster analysis techniques to produce a habitat suitability map.

## Task 1: Data Exploration and Project Setup

### Setup Your Workspace

1. Create a new R Project
2. Download the exercise data from Moodle (section "CW 39 -- Spatial Analysis II")
3. Extract the data into your new folder
4. Create a new R script or Quarto document for this exercise

### Understanding Your Data

Your downloaded data folder contains several datasets:

::: {.callout-note}
## Input Datasets

- **Raster data:**
  -   `dhm25_lu.tif` - Digital elevation model at 25m resolution
- **Vector data (in GeoPackages):**
  -   `tlm_bb` (polygon layer) - Land cover classification from swiss_TLM3.gpkg
  -   `tlm_strassen` (line layer) - Road network from swiss_TLM3.gpkg
  -   `arealstatistik` (point layer) - Swiss land use statistics from Arealstatistik.gpkg
  -   `kantonsgebiet_lu` (polygon layer) - Canton boundary from swissBOUNDARIES3D.gpkg
:::

### Metadata Resources

Understanding your data is crucial for proper analysis. Familiarize yourself with these metadata sources:

-   **DHM25**: [Data source & description](https://www.swisstopo.admin.ch/de/hoehenmodell-dhm25)
-   **swissTLM3D**: [Data source & description](https://www.swisstopo.admin.ch/de/landschaftsmodell-swisstlm3d) | [Objektkatalog (2024)](https://backend.swisstopo.admin.ch/fileservice/sdweb-docs-prod-swisstopoch-files/files/2024/03/06/b2e890ee-a5a4-4ea6-8b87-13f74eb41a1a.pdf)
-   **Arealstatistik BFS**: [Data source & description](https://www.bfs.admin.ch/bfs/de/home/dienstleistungen/geostat/geodaten-bundesstatistik/boden-nutzung-bedeckung-eignung/arealstatistik-schweiz.html) | [Nomenklatur 72 Grundkategorien](https://www.bfs.admin.ch/bfs/de/home/statistiken/raum-umwelt/nomenklaturen/arealstatistik/noas2004/72-grundkategorien.html)

::: {.callout-tip}
## Hint: Required R Packages
You'll need the following packages for this exercise:

- `sf` for vector data
- `terra` for raster data
- `dplyr` for data manipulation
- `ggplot2` or `tmap` for visualisation
:::

### Your First Tasks

Load the data and explore its properties. Consider these questions:

1. What coordinate reference system (CRS) are the datasets using?
2. What is the spatial extent and resolution of the elevation model?
3. What attributes are available in each vector layer?
4. Do all datasets cover the same geographic area?

```{r}
# Load packages
library(sf)
library(terra)
library(dplyr)

# Set working directory
setwd("path/to/GIScience_GDB/Spatial_Analysis_II")
```

```{r}
# Read raster data
dhm25 <- rast("dhm25_lu.tif")

# Read vector data from geopackages
tlm_bb <- st_read("swiss_TLM3.gpkg", layer = "tlm_bb")
tlm_strassen <- st_read("swiss_TLM3.gpkg", layer = "tlm_strassen")
arealstatistik <- st_read("Arealstatistik.gpkg", layer = "arealstatistik")
kantonsgebiet_lu <- st_read("swissBOUNDARIES3D.gpkg", layer = "kantonsgebiet_lu")
```

```{r}
# Check the CRS (should be EPSG:2056)
st_crs(tlm_bb)
crs(dhm25)

# Check extent and resolution
dhm25
ext(dhm25)
res(dhm25)

# View the first few rows of vector data
head(tlm_bb)
```

Create a visualization to familiarize yourself with the data.

```{r}
#| label: fig-study-area
#| fig-cap: "Digital elevation model of Canton Lucerne"
# Plot elevation model
plot(dhm25, main = "DHM25 - Canton of Lucerne")

# Add canton boundary
plot(st_geometry(kantonsgebiet_lu), add = TRUE, border = "red", lwd = 2)
```

## Task 2: Create a Forest Cover Raster

**Objective**: Convert the vector-based land cover layer (`tlm_bb`) into a raster format that represents forest areas. This raster will serve as one of your habitat suitability criteria.

**Background**: Before proceeding, consult the swissTLM3D [Objektkatalog](https://backend.swisstopo.admin.ch/fileservice/sdweb-docs-prod-swisstopoch-files/files/2024/03/06/b2e890ee-a5a4-4ea6-8b87-13f74eb41a1a.pdf) to understand the classification system. The land use types are stored in the field **"OBJEKTART"** (see TOPIC TLM_BB).

::: {.callout-important}
## Think About This
Which `OBJEKTART` categories represent forest that chamois would use for refuge? Consider different forest types and their characteristics.
:::

### Workflow Steps

Your task involves several sequential operations:

1. **Select forest features** - Filter the `tlm_bb` layer to extract only forest-related land cover types
2. **Dissolve boundaries** - Merge all forest polygons into a single multipart feature
3. **Rasterize** - Convert the vector layer to raster format using the DHM25 as a template
4. **Validate** - Examine the output to ensure it's correct

::: {.callout-tip}
## Hint: Forest Categories
For this analysis, consider these forest types as suitable chamois habitat:
- Gebüschwald
- Wald
- Wald offen
:::

::: {.callout-tip collapse="true"}
## Hint: Vector to Raster Conversion
When rasterizing:
- Use the DHM25 as a template to ensure matching extent and resolution
- The `terra` package has a `rasterize()` function
- You may need to convert sf objects to terra's vect format
- Consider what value to assign to forest cells (e.g., 1 = forest)
:::

```{r}
# Filter forest types using dplyr
forest <- tlm_bb %>%
  filter(objektart %in% c('Gebueschwald', 'Wald', 'Wald offen'))

# Check the result
nrow(forest)
```

```{r}
# Save to geopackage
st_write(forest, "swissTLM3D.gpkg", layer = "forest", append = FALSE)
```

```{r}
# Dissolve using st_union
forest_dissolve <- forest %>%
  st_union() %>%
  st_as_sf() %>%
  mutate(OBJECTID = 1)

# Check the result - should be 1 feature
nrow(forest_dissolve)
```

```{r}
# Create a template raster based on dhm25
template <- dhm25

# Rasterize the forest layer
# Use rasterize() function with the polygon and value 1 for forest
forest_raster <- rasterize(vect(forest_dissolve), template, field = 1)

# Write the raster to file
writeRaster(forest_raster, "forest_raster.tif", overwrite = TRUE, datatype = "INT1U")
```

```{r}
#| label: fig-forest-raster
#| fig-cap: "Forest areas in Canton Lucerne"
# Plot the forest raster
plot(forest_raster, main = "Forest Raster", col = c("white", "darkgreen"),
     legend = FALSE)
```

```{r}
# Check data type
datatype(forest_raster)

# Get unique values
unique(forest_raster)

# Get frequency table
freq(forest_raster)
```

::: {.callout-note}
## Reflection Question
Examine the properties of your `forest_raster`. Is it an integer or floating-point raster? What values does it contain? Why might this matter for subsequent analyses?
:::

## Task 3: Derive Terrain Slope

**Objective**: Calculate slope from the digital elevation model. Slope is a critical habitat parameter - chamois use steep terrain as refuges where they have physiological advantages over predators.

**Background**: Slope represents the rate of change in elevation and can be calculated from a DEM using neighborhood operations. The `terra` package provides the `terrain()` function for this purpose.

::: {.callout-tip collapse="true"}
## Hint: Terrain Analysis
- The `terrain()` function requires specifying which terrain variable to calculate (e.g., "slope", "aspect")
- Choose appropriate units for your analysis (degrees vs. radians)
- The output will be a floating-point raster
:::

```{r}
# Calculate slope in degrees
slope <- terrain(dhm25, v = "slope", unit = "degrees")

# Write to file
writeRaster(slope, "slope.tif", overwrite = TRUE)
```

```{r}
#| label: fig-slope
#| fig-cap: "Slope distribution in Canton Lucerne"
# Plot slope
plot(slope, main = "Slope (degrees)", col = terrain.colors(100))
```

```{r}
# Check data type
datatype(slope)

# Get summary statistics
summary(slope)

# Get the maximum slope value
global(slope, "max", na.rm = TRUE)
```

::: {.callout-note}
## Reflection Questions
- What data type is the slope raster? Why does this differ from the forest raster?
- What is the steepest slope in your study area? Is this realistic?
- Where would you expect to find the steepest slopes?
:::

## Task 4: Identify Steep Terrain

**Objective**: Reclassify the continuous slope values into a binary classification: steep vs. non-steep areas. Based on ecological studies, chamois benefit from slopes steeper than 30°.

**Background**: Reclassification transforms continuous data into categorical classes. You'll create a binary raster where:
- **0** = non-steep areas (0-30°)
- **1** = steep areas (>30°)

::: {.callout-tip collapse="true"}
## Hint: Reclassification in terra
The `classify()` function uses a reclassification matrix with three columns:
- Column 1: Lower bound of range
- Column 2: Upper bound of range
- Column 3: New value to assign

Remember to use `include.lowest = TRUE` to handle boundary values correctly.
:::

```{r}
# Create reclassification matrix
# Format: from, to, new_value
rcl_matrix <- matrix(c(0, 30, 0,
                       30, 100, 1),
                     ncol = 3, byrow = TRUE)

# Reclassify
steep_nosteep <- classify(slope, rcl_matrix, include.lowest = TRUE)

# Write to file
writeRaster(steep_nosteep, "steep_nosteep.tif", overwrite = TRUE, datatype = "INT1U")
```

```{r}
#| label: fig-steep-areas
#| fig-cap: "Steep (>30°) vs non-steep areas"
# Plot the reclassified raster
plot(steep_nosteep, main = "Steep (>30°) vs Non-steep Areas",
     col = c("lightblue", "red"), legend = FALSE)
legend("topright", legend = c("Non-steep (<30°)", "Steep (>30°)"),
       fill = c("lightblue", "red"))
```

```{r}
# Get frequency table
freq(steep_nosteep)
```

## Task 5: Extract High-Traffic Roads

**Objective**: Identify heavily trafficked roads that chamois would avoid. While we don't have direct traffic volume data, we can use road type as a proxy for traffic intensity.

**Background**: Consult the swissTLM3D Objektkatalog to understand the road classification system. The `OBJEKTART` field contains road type information, and the `KUNSTBAUTE` field indicates infrastructure like tunnels.

::: {.callout-important}
## Important Consideration
Why should roads in tunnels be excluded from this analysis? Think about how chamois would perceive and respond to different road types.
:::

::: {.callout-tip}
## Hint: Road Types to Consider
Major road types that typically carry high traffic:
- Autobahn (highways)
- Autostrasse (expressways)
- 10m, 8m, 6m, 4m Strasse (roads classified by width)
- Einfahrt, Ausfahrt, Zufahrt (on/off ramps and access roads)

Exclude roads where `KUNSTBAUTE` equals "Tunnel".
:::

```{r}
# Define the road types to extract
road_types <- c('Ausfahrt', 'Einfahrt', 'Autobahn', 'Zufahrt',
                '10m Strasse', '6m Strasse', '4m Strasse',
                '8m Strasse', 'Autostrasse')

# Filter roads, excluding tunnels
heavy_used_roads <- tlm_strassen %>%
  filter(objektart %in% road_types & kunstbaute != 'Tunnel')

# Check the result
nrow(heavy_used_roads)
```

```{r}
# Save to geopackage
st_write(heavy_used_roads, "swissTLM3D.gpkg", layer = "heavy_used_roads",
         append = FALSE)
```

```{r}
#| label: fig-roads
#| fig-cap: "Heavily trafficked roads in Canton Lucerne"
# Simple plot
plot(st_geometry(kantonsgebiet_lu), main = "Heavily Used Roads")
plot(st_geometry(heavy_used_roads), col = "red", add = TRUE)
```

## Task 6: Delineate Settlement Areas

**Objective**: Create a spatial layer representing human settlement areas that chamois would avoid. You'll use the Swiss Land Use Statistics (Arealstatistik) dataset for this purpose.

**Background**: The [Arealstatistik](https://www.bfs.admin.ch/bfs/de/home/dienstleistungen/geostat/geodaten-bundesstatistik/boden-nutzung-bedeckung-eignung/arealstatistik-schweiz.html) provides detailed land use information at the hectare level. The dataset uses a classification system with 72 basic categories (see [Nomenklatur 72 Grundkategorien](https://www.bfs.admin.ch/bfs/de/home/statistiken/raum-umwelt/nomenklaturen/arealstatistik/noas2004/72-grundkategorien.html)).

::: {.callout-important}
## Your Task: Define Settlement Areas
Before looking at the hint below, download and examine the variable list ([xlsx-file](https://dam-api.bfs.admin.ch/hub/api/dam/assets/32376296/master)) - specifically the sheet "Codes AS_72".

**Think about:** Which categories represent areas where human activity would disturb chamois? Consider different types of buildings and their surroundings (in German, "Umschwung" refers to the area immediately surrounding buildings).
:::

::: {.callout-tip collapse="true"}
## Hint: Settlement Categories (AS_72 codes)
For this analysis, consider these categories as settlement areas:
- 1: Industrie- und Gewerbegebäude
- 2: Umschwung von Industrie- und Gewerbegebäuden
- 3: Ein- und Zweifamilienhäuser
- 4: Umschwung von Ein- und Zweifamilienhäusern
- 5: Reihen- und Terrassenhäuser
- 6: Umschwung von Reihen- und Terrassenhäusern
- 7: Mehrfamilienhäuser
- 8: Umschwung von Mehrfamilienhäusern
- 9: Öffentliche Gebäude
- 10: Umschwung von öffentlichen Gebäuden
- 11: Landwirtschaftliche Gebäude
- 13: Nicht spezifizierte Gebäude
:::

### Workflow

Your analysis should:

1. **Filter** the Arealstatistik points to extract settlement-related categories
2. **Buffer** these points by 150 meters (representing a zone of human influence)
3. **Dissolve** overlapping buffers to create contiguous settlement areas

::: {.callout-note}
## Why Buffer?
The Arealstatistik uses point samples at hectare intervals. Buffering creates a more realistic representation of settlement extent and the zone of human disturbance around settlements.
:::

```{r}
# Define settlement codes
settlement_codes <- c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 13)

# Filter settlement points
# Note: Adjust the field name if your data uses a different name
settlement_as72 <- arealstatistik %>%
  filter(AS72 %in% settlement_codes)

# Check result
nrow(settlement_as72)
```

```{r}
# Create buffer and dissolve
settlement_area <- settlement_as72 %>%
  st_buffer(dist = 150) %>%
  st_union() %>%
  st_as_sf()

# Check result - should be one or few features
nrow(settlement_area)
```

```{r}
# Save intermediate and final result
st_write(settlement_as72, "Arealstatistik.gpkg", layer = "settlement_as72",
         append = FALSE)
st_write(settlement_area, "Arealstatistik.gpkg", layer = "settlement_area",
         append = FALSE)
```

```{r}
#| label: fig-settlements
#| fig-cap: "Settlement areas with 150m buffer zones"
# Plot
plot(st_geometry(kantonsgebiet_lu), main = "Settlement Areas")
plot(st_geometry(settlement_area), col = "orange", add = TRUE)
```

## Task 7: Analyze Local Habitat Characteristics

**Objective**: Evaluate the landscape surrounding every location in terms of forest cover and steep terrain availability. This analysis accounts for the chamois home range size (~1 km²) by examining the local neighborhood around each potential habitat location.

### Conceptual Background

Chamois don't just need forest and steep slopes - they need sufficient amounts of these resources *within their home range*. A focal (moving window) analysis evaluates each cell by examining its neighborhood, essentially asking: "If a chamois lived here, would there be enough resources within its typical home range?"

::: {.callout-important}
## Think About This
- Why is it not enough to simply identify where forests and steep slopes exist?
- How does home range size influence habitat suitability?
- What does it mean if a location has high forest cover within 1 km² but no steep slopes nearby?
:::

### Data Preparation

Before conducting focal statistics, you need to handle NA (no data) values. Binary rasters (forest/non-forest, steep/non-steep) need to explicitly represent "absence" as 0 rather than NA.

::: {.callout-tip collapse="true"}
## Hint: Replacing NA Values
Use the `classify()` function with a reclassification matrix that maps NA to 0:
```r
new_raster <- classify(old_raster, cbind(NA, 0))
```
:::

```{r}
# Replace NA with 0 in forest raster
forest_raster_final <- classify(forest_raster, cbind(NA, 0))

# Write to file
writeRaster(forest_raster_final, "forest_raster_final.tif",
            overwrite = TRUE, datatype = "INT1U")
```

### Calculate Window Size

To represent a 1 km² home range, you need to determine the appropriate window size in raster cells.

::: {.callout-note}
## Mathematical Approach
Given:
- Home range area = 1 km² = 1,000,000 m²
- Raster resolution = 25m × 25m = 625 m² per cell
- Number of cells needed = 1,000,000 m² ÷ 625 m²/cell = ?
- Window dimensions (assuming square window) = √(number of cells) = ?

Calculate this yourself, then check the code below.
:::

```{r}
# Calculate window size
# 1 km² = 1,000,000 m²
# Cell size = 25m × 25m = 625 m²
# Number of cells = 1,000,000 / 625 = 1600 cells
# For a square window: sqrt(1600) = 40 cells
# So we use a 39×39 or 40×40 window (approximately 1 km²)
window_size <- 39
```

### Perform Focal Analysis

The focal analysis counts how many forest cells (or steep cells) exist within the moving window around each location.

::: {.callout-tip collapse="true"}
## Hint: Focal Analysis in terra
The `focal()` function requires:
- Input raster
- Weight matrix (`w`) - use `matrix(1, nrow=size, ncol=size)` for equal weights
- Function to apply (`fun = "sum"` to count cells with value 1)
- `na.rm = TRUE` to handle any remaining NA values
:::

```{r}
# Create a weight matrix (all values = 1 for sum)
w <- matrix(1, nrow = window_size, ncol = window_size)

# Calculate focal sum for forest
focal_forest <- focal(forest_raster_final, w = w, fun = "sum", na.rm = TRUE)

# Write to file
writeRaster(focal_forest, "focal_forest.tif", overwrite = TRUE)
```

```{r}
# First, ensure steep_nosteep has 0 for NA values
steep_nosteep_filled <- classify(steep_nosteep, cbind(NA, 0))

# Calculate focal sum for steep areas
focal_steepness <- focal(steep_nosteep_filled, w = w, fun = "sum", na.rm = TRUE)

# Write to file
writeRaster(focal_steepness, "focal_steepness.tif", overwrite = TRUE)
```

```{r}
#| label: fig-focal-results
#| fig-cap: "Focal analysis results showing local resource availability"
#| fig-subcap:
#|   - "Forest cell count within 1 km²"
#|   - "Steep terrain cell count within 1 km²"
#| layout-ncol: 2
# Plot focal forest
plot(focal_forest, main = "Focal Forest Count",
     col = viridis::viridis(100))

# Plot focal steepness
plot(focal_steepness, main = "Focal Steepness Count",
     col = viridis::viridis(100))
```

```{r}
# Get summary statistics
summary(focal_forest)
summary(focal_steepness)

# Get min and max values
global(focal_forest, c("min", "max"), na.rm = TRUE)
global(focal_steepness, c("min", "max"), na.rm = TRUE)
```

::: {.callout-note}
## Interpret Your Results
The output values typically range from 0 to ~1500-1600.

**Think about:**
- What does a value of 0 mean? What about 1600?
- Why might the maximum be less than 1600 (the theoretical maximum)?
- Which areas have the highest forest counts? Highest steep terrain counts?
- How do these patterns relate to the topography of Canton Lucerne?
:::

## Task 8: Calculate Distance to Human Disturbance

**Objective**: Quantify how far each location is from human disturbance sources (settlements and major roads). Chamois are sensitive to human activity, so greater distances should indicate better habitat quality.

**Background**: Distance calculations create continuous surfaces where each cell's value represents its proximity to the nearest feature. This allows you to model avoidance behavior - animals may select habitat based on distance to disturbance sources.

::: {.callout-important}
## Conceptual Question
How is a distance-based criterion different from the binary (present/absent) classification we used for forest and steep areas? Why use distance rather than simply excluding areas near roads and settlements?
:::

### Workflow

To calculate distances in a raster environment:

1. **Rasterize** vector features (roads and settlements)
2. **Calculate Euclidean distance** from each cell to the nearest feature
3. **Analyze** the resulting distance surfaces

::: {.callout-tip collapse="true"}
## Hint: Distance Calculation
The terra `distance()` function:
- Takes a raster where features are marked with values (typically 1)
- Calculates the straight-line distance from each cell to the nearest non-NA cell
- Returns distances in map units (meters for EPSG:2056)
:::

```{r}
# Rasterize heavy_used_roads
roads_raster <- rasterize(vect(heavy_used_roads), template, field = 1)
writeRaster(roads_raster, "roads_raster.tif", overwrite = TRUE, datatype = "INT1U")

# Rasterize settlement_area
settlement_raster <- rasterize(vect(settlement_area), template, field = 1)
writeRaster(settlement_raster, "settlement_raster.tif", overwrite = TRUE,
            datatype = "INT1U")
```

```{r}
# Calculate Euclidean distance from roads
# The distance() function calculates distance to nearest non-NA cell
distance_roads <- distance(roads_raster)

# Write to file
writeRaster(distance_roads, "distance_roads.tif", overwrite = TRUE)
```

```{r}
# Calculate Euclidean distance from settlements
distance_settlement <- distance(settlement_raster)

# Write to file
writeRaster(distance_settlement, "distance_settlement.tif", overwrite = TRUE)
```

```{r}
#| label: fig-distances
#| fig-cap: "Distance surfaces from human disturbance sources"
#| fig-subcap:
#|   - "Distance to major roads (meters)"
#|   - "Distance to settlements (meters)"
#| layout-ncol: 2
# Plot distance to roads
plot(distance_roads, main = "Distance to Roads",
     col = heat.colors(100))

# Plot distance to settlements
plot(distance_settlement, main = "Distance to Settlements",
     col = heat.colors(100))
```

```{r}
# Get summary statistics
summary(distance_roads)
summary(distance_settlement)

# Get min and max distances
global(distance_roads, c("min", "max"), na.rm = TRUE)
global(distance_settlement, c("min", "max"), na.rm = TRUE)
```

::: {.callout-note}
## Reflection Questions
- What are the maximum distances to roads and settlements in your study area?
- Where would you expect to find the most remote areas?
- How might chamois use areas at different distances from human activity?
- Could there be areas that are *too* remote for chamois? What other factors might limit habitat beyond distance to disturbance?
:::

## Task 9: Standardize Criteria to Common Scale

**Objective**: Transform all four habitat criteria onto a common suitability scale, enabling meaningful comparison and combination of different environmental factors.

### The Standardization Problem

You now have four criteria measured in different units:
- `focal_forest`: count of forest cells (0-1600)
- `focal_steepness`: count of steep cells (0-1600)
- `distance_roads`: meters (0-several thousand)
- `distance_settlement`: meters (0-several thousand)

::: {.callout-important}
## Critical Question
Why can't we directly combine these raw values? What problems would arise if we simply added them together?

Consider:
- A location with 500 forest cells + 500 steep cells + 5000m from roads + 3000m from settlements = 9000
- Another location with 100 forest cells + 100 steep cells + 200m from roads + 100m from settlements = 500

Does the first location really have 18× better habitat? How do the different measurement units affect interpretation?
:::

### Solution: Suitability Classification (Grading)

Standardize all criteria using a common five-class suitability scale:

- **1** = unsuitable
- **2** = conditionally suitable
- **3** = moderately suitable
- **4** = well suitable
- **5** = very well suitable

### Classification Thresholds

The following thresholds are based on ecological considerations and expert knowledge:

::: {.panel-tabset}
### Forest Cover
**focal_forest** (cell count within 1 km²):

- 0 - 300 → 1 (unsuitable: <20% forest)
- 300 - 600 → 2 (conditional: 20-37%)
- 600 - 900 → 3 (moderate: 37-56%)
- 900 - 1200 → 4 (good: 56-75%)
- 1200 - 2000 → 5 (excellent: >75%)

### Steep Terrain
**focal_steepness** (cell count within 1 km²):

- 0 - 200 → 1 (unsuitable: <12% steep)
- 200 - 400 → 2 (conditional: 12-25%)
- 400 - 600 → 3 (moderate: 25-37%)
- 600 - 800 → 4 (good: 37-50%)
- 800 - 2000 → 5 (excellent: >50%)

### Road Distance
**distance_roads** (meters):

- 0 - 150 → 1 (unsuitable: very close)
- 150 - 300 → 2 (conditional: close)
- 300 - 450 → 3 (moderate: medium distance)
- 450 - 600 → 4 (good: far)
- 600 - 20000 → 5 (excellent: very far)

### Settlement Distance
**distance_settlement** (meters):

- 0 - 250 → 1 (unsuitable: very close)
- 250 - 500 → 2 (conditional: close)
- 500 - 750 → 3 (moderate: medium distance)
- 750 - 1000 → 4 (good: far)
- 1000 - 20000 → 5 (excellent: very far)
:::

::: {.callout-note}
## Think About the Thresholds
These classifications represent ecological hypotheses about chamois habitat preferences.

**Questions to consider:**
- Are these thresholds reasonable?
- How might you validate or refine them?
- Should all criteria have equal weight in the final analysis?
- How sensitive might the results be to these classification boundaries?
:::

### Perform the Reclassifications

Now apply these classification schemes to each criterion. You'll use the same reclassification approach you learned earlier.

```{r}
# Create reclassification matrix for forest
rcl_forest <- matrix(c(0, 300, 1,
                       300, 600, 2,
                       600, 900, 3,
                       900, 1200, 4,
                       1200, 2000, 5),
                     ncol = 3, byrow = TRUE)

# Reclassify
grading_forest <- classify(focal_forest, rcl_forest, include.lowest = TRUE)

# Write to file
writeRaster(grading_forest, "grading_forest.tif", overwrite = TRUE,
            datatype = "INT1U")
```

```{r}
# Create reclassification matrix for steepness
rcl_steepness <- matrix(c(0, 200, 1,
                          200, 400, 2,
                          400, 600, 3,
                          600, 800, 4,
                          800, 2000, 5),
                        ncol = 3, byrow = TRUE)

# Reclassify
grading_steepness <- classify(focal_steepness, rcl_steepness,
                              include.lowest = TRUE)

# Write to file
writeRaster(grading_steepness, "grading_steepness.tif", overwrite = TRUE,
            datatype = "INT1U")
```

```{r}
# Create reclassification matrix for roads
rcl_roads <- matrix(c(0, 150, 1,
                      150, 300, 2,
                      300, 450, 3,
                      450, 600, 4,
                      600, 20000, 5),
                    ncol = 3, byrow = TRUE)

# Reclassify
grading_roads <- classify(distance_roads, rcl_roads, include.lowest = TRUE)

# Write to file
writeRaster(grading_roads, "grading_roads.tif", overwrite = TRUE,
            datatype = "INT1U")
```

```{r}
# Create reclassification matrix for settlement
rcl_settlement <- matrix(c(0, 250, 1,
                           250, 500, 2,
                           500, 750, 3,
                           750, 1000, 4,
                           1000, 20000, 5),
                         ncol = 3, byrow = TRUE)

# Reclassify
grading_settlement <- classify(distance_settlement, rcl_settlement,
                               include.lowest = TRUE)

# Write to file
writeRaster(grading_settlement, "grading_settlement.tif", overwrite = TRUE,
            datatype = "INT1U")
```

### Visualize and Compare

Examine all four standardized criteria side-by-side:

```{r}
#| label: fig-grading
#| fig-cap: "Standardized suitability scores for all four criteria"
#| fig-width: 10
#| fig-height: 10
# Define a color palette for grading (1-5)
grading_colors <- c("#d7191c", "#fdae61", "#ffffbf", "#a6d96a", "#1a9641")

# Plot all four grading layers
par(mfrow = c(2, 2))
plot(grading_forest, main = "Forest Suitability", col = grading_colors,
     breaks = 0:5 + 0.5)
plot(grading_steepness, main = "Steep Terrain Suitability", col = grading_colors,
     breaks = 0:5 + 0.5)
plot(grading_roads, main = "Road Distance Suitability", col = grading_colors,
     breaks = 0:5 + 0.5)
plot(grading_settlement, main = "Settlement Distance Suitability",
     col = grading_colors, breaks = 0:5 + 0.5)
par(mfrow = c(1, 1))
```

```{r}
# Get frequency tables
freq(grading_forest)
freq(grading_steepness)
freq(grading_roads)
freq(grading_settlement)
```

::: {.callout-note}
## Compare the Patterns
Now that all criteria are on the same scale (1-5), you can meaningfully compare them.

**Look for:**
- Which criterion shows the most variability?
- Which areas score high on multiple criteria?
- Are there any surprising patterns?
- How do topographic factors (forest, slope) relate to human factors (roads, settlements)?
:::

## Task 10: Multi-Criteria Overlay Analysis

**Objective**: Combine all four standardized criteria into a single habitat suitability map using raster overlay analysis.

### Conceptual Background

Now that all criteria are on a common 1-5 scale, you can combine them to identify areas that satisfy multiple habitat requirements simultaneously. This is the essence of Multi-Criteria Evaluation (MCE).

::: {.callout-important}
## Think About the Method
We'll use a simple additive model (sum of all criteria).

**Consider:**
- What assumptions does this make about how criteria interact?
- Does it assume all criteria are equally important?
- Could two moderate scores compensate for one poor score?
- What's the theoretical range of output values? (Min = ?, Max = ?)
:::

### Perform the Overlay

One of the great advantages of raster data is that map algebra is straightforward - you can use standard arithmetic operators:

```{r}
# Calculate the sum of all four grading layers
grading_sum <- grading_forest + grading_steepness +
               grading_roads + grading_settlement

# Write to file
writeRaster(grading_sum, "grading_sum.tif", overwrite = TRUE,
            datatype = "INT1U")
```

### Analyze the Results

```{r}
# Get summary statistics
summary(grading_sum)

# Get min and max values
global(grading_sum, c("min", "max"), na.rm = TRUE)

# Get frequency distribution
freq(grading_sum)
```

::: {.callout-note}
## Interpret the Value Range
The sum values range from 4 (all criteria scored 1) to 20 (all criteria scored 5).

**What does this mean?**
- **4-8**: Poor habitat - multiple limiting factors
- **9-14**: Moderate habitat - mixed conditions
- **15-20**: Excellent habitat - all requirements met

Do you observe the full range in your study area? Why or why not?
:::

### Visualize the Habitat Suitability Map

```{r}
#| label: fig-suitability-continuous
#| fig-cap: "Continuous habitat suitability scores for chamois in Canton Lucerne"
# Create a diverging color palette for the sum (values from 4 to 20)
library(viridis)

# Plot the final suitability map
plot(grading_sum, main = "Chamois Habitat Suitability (Sum of Criteria)",
     col = viridis(17),
     breaks = seq(3.5, 20.5, by = 1))

# Add canton boundary
plot(st_geometry(kantonsgebiet_lu), add = TRUE, border = "black", lwd = 2)
```

### Create Simplified Classification

For management and communication purposes, create a three-class version:

```{r}
#| label: fig-suitability-classified
#| fig-cap: "Classified habitat suitability for chamois"
# Reclassify into broader suitability categories
# Low suitability: 4-8, Medium: 9-14, High: 15-20
suit_classes <- matrix(c(4, 8, 1,
                         9, 14, 2,
                         15, 20, 3),
                       ncol = 3, byrow = TRUE)

habitat_classes <- classify(grading_sum, suit_classes, include.lowest = TRUE)

# Plot classified version
plot(habitat_classes, main = "Chamois Habitat Suitability Classes",
     col = c("#d7191c", "#ffffbf", "#1a9641"),
     breaks = c(0.5, 1.5, 2.5, 3.5),
     legend = FALSE)
legend("topright",
       legend = c("Low (4-8)", "Medium (9-14)", "High (15-20)"),
       fill = c("#d7191c", "#ffffbf", "#1a9641"))
plot(st_geometry(kantonsgebiet_lu), add = TRUE, border = "black", lwd = 2)
```

::: {.callout-note}
## Geographic Patterns
Examine your final map carefully:

- Where are the most suitable habitats located?
- What geographic features characterize high-suitability areas?
- Are there surprising results? Areas you expected to be suitable that aren't, or vice versa?
- How contiguous are the suitable habitat patches?
:::

## Task 11: Model Validation and Critical Evaluation

**Objective**: Critically evaluate your habitat suitability model by comparing it with actual chamois distribution data and calculating quantitative statistics.

### Final Data Processing

Create a final, polished version of your suitability map:

```{r}
# Optionally, crop to canton boundary for cleaner visualization
grading_sum_crop <- mask(grading_sum, vect(kantonsgebiet_lu))

# Write the final result
writeRaster(grading_sum_crop, "chamois_habitat_suitability_final.tif",
            overwrite = TRUE)
```

### Calculate Habitat Availability

Quantify how much suitable habitat exists in each suitability class:

```{r}
# Calculate area statistics
# Convert pixel count to km²
cell_area_km2 <- (res(grading_sum)[1] * res(grading_sum)[2]) / 1000000

# Get area by suitability class
suitability_stats <- freq(habitat_classes)
suitability_stats$area_km2 <- suitability_stats$count * cell_area_km2
print(suitability_stats)
```

::: {.callout-note}
## Interpret the Statistics
- What percentage of Canton Lucerne is "highly suitable" for chamois?
- How much area is in each category?
- Does this match your expectations based on the canton's geography?
:::

### Compare with Actual Distribution

Now validate your model against reality. Visit the Info Fauna database to view actual chamois observations:

**[Chamois Distribution Map - Info Fauna](https://lepus.infofauna.ch/carto/70791)**

::: {.callout-important}
## Critical Evaluation
Compare your suitability map with the actual distribution:

**Questions to consider:**
1. Do areas with high predicted suitability show actual chamois presence?
2. Are there areas you predicted as suitable but have no observations? Why might this be?
3. Are there observed chamois in areas your model predicts as unsuitable? What factors might your model be missing?
4. How well does your model capture the overall distribution pattern?
5. What are the main sources of agreement and disagreement?

**Important:** Absence of observations doesn't always mean absence of animals - consider sampling effort, accessibility, and data reporting biases.
:::

## Critical Discussion

### Model Limitations and Improvements

::: {.callout-warning}
## Reflect on Your Methodology
Your model makes several simplifying assumptions. Consider these limitations and potential improvements:
:::

#### 1. Equal Weighting of Criteria

**Current approach:** All four criteria contribute equally (simple sum).

**Questions:**
- Is forest cover really as important as distance to settlements?
- Should steep terrain be weighted more heavily, as it's a primary anti-predator strategy?
- How could you determine appropriate weights?

::: {.callout-tip collapse="true"}
## Hint: Weighted Overlay
You could modify the overlay to use weights:
```r
# Example: assign different importance weights
weighted_suitability <- 0.3*grading_forest + 0.3*grading_steepness +
                        0.2*grading_roads + 0.2*grading_settlement
```
:::

#### 2. Classification Thresholds

**Current approach:** Fixed thresholds based on general ecological principles.

**Improvements:**
- Calibrate thresholds using actual chamois location data
- Use statistical methods (e.g., resource selection functions)
- Incorporate uncertainty in threshold definitions
- Test sensitivity to different threshold values

#### 3. Missing Criteria

**What factors did we omit?**

::: {.panel-tabset}
### Environmental
- **Elevation**: Chamois prefer specific elevation ranges (typically 1000-3000m in Alps)
- **Aspect**: South-facing slopes have less snow and earlier vegetation
- **Vegetation type**: Not all forests are equal - species composition matters
- **Snow depth**: Critical for winter survival and accessibility
- **Rock/cliff presence**: Provides additional escape terrain

### Human Impact
- **Recreation areas**: Hiking trails, ski resorts, climbing areas
- **Seasonal access**: Different impacts in winter vs. summer
- **Hunting pressure**: Legal hunting affects distribution
- **Historical presence**: Where have chamois traditionally been?

### Biotic Interactions
- **Predators**: Lynx, wolf distribution
- **Competitors**: Red deer, ibex overlap
- **Disease**: Presence of keratoconjunctivitis or other diseases
:::

#### 4. Compensatory vs. Limiting Factors

**Current model:** Allows compensation - high scores on some criteria can offset low scores on others.

**Ecological reality:** Some factors may be *limiting* - absolutely required regardless of other conditions.

::: {.callout-important}
## Think About This
Should the model allow an area with zero steep terrain but excellent forest cover to be classified as "suitable"? Or is steep terrain a non-negotiable requirement?

You could implement threshold constraints:
```r
# Example: require minimum steepness
suitable_habitat <- grading_sum
suitable_habitat[grading_steepness < 3] <- NA  # Exclude areas without adequate steep terrain
```
:::

### Data Quality Considerations

#### Spatial Resolution
- Is 25m appropriate for modeling home ranges of ~1 km²?
- How does resolution affect focal analysis results?

#### Temporal Mismatch
- Are all datasets from the same time period?
- Have land use patterns changed since data collection?

#### Data Accuracy
- How accurate is the land cover classification?
- Are road and settlement data complete and current?

### Scale Dependencies

::: {.callout-note}
## Multi-Scale Considerations
Chamois habitat selection operates at multiple scales:
- **Regional scale**: Climate, elevation zones
- **Landscape scale**: Home range characteristics (what we modeled)
- **Local scale**: Specific feeding sites, bedding areas

Your model addresses primarily the landscape scale. Results might differ at other scales.
:::

## Extension Ideas

If you want to take this analysis further:

### 1. Remove Water Bodies

```{r}
# Example code to mask water areas
# Assuming AS72 codes 18-19 represent water bodies (check the classification!)
# water <- arealstatistik %>% filter(AS72 %in% c(18, 19))
# water_buffer <- water %>% st_buffer(50)  # Add small buffer
# water_raster <- rasterize(vect(water_buffer), template, field = 1)
# grading_sum_no_water <- mask(grading_sum, water_raster, inverse = TRUE)
```

### 2. Add Elevation Constraints

```{r}
# Example: mask areas outside typical elevation range
# suitable_elevation <- dhm25 >= 800 & dhm25 <= 2500
# grading_sum_elev <- mask(grading_sum, suitable_elevation, maskvalues = 0)
```

### 3. Conduct Sensitivity Analysis

Test how results change with different:
- Classification thresholds
- Criterion weights
- Home range window sizes
- Inclusion/exclusion of criteria

### 4. Validate Quantitatively

If you have access to presence/absence data:
- Calculate AUC (Area Under Curve) or similar metrics
- Perform cross-validation
- Test predictive accuracy

## Concluding Thoughts

::: {.callout-important}
## Professional Responsibility
As a GIS analyst, you must:

✓ **Acknowledge limitations** - No model is perfect; be transparent about assumptions and constraints
✓ **Validate results** - Compare predictions with empirical data whenever possible
✓ **Consider context** - Understand the ecology, not just the technical methods
✓ **Communicate uncertainty** - Decision-makers need to know confidence levels
✓ **Document thoroughly** - Future users must understand your methodology

**Remember:** A beautiful map doesn't necessarily represent reality. Critical thinking and validation are essential.
:::

## Summary of Key Concepts

Through this exercise, you've learned:

1. **Vector to raster conversion** - Transforming different data types for analysis
2. **Terrain analysis** - Deriving slope from elevation data
3. **Reclassification** - Converting continuous and categorical data
4. **Focal analysis** - Neighborhood operations for landscape context
5. **Distance calculation** - Euclidean distance surfaces
6. **Multi-criteria evaluation** - Standardization and overlay of disparate criteria
7. **Model validation** - Comparing predictions with observations
8. **Critical evaluation** - Understanding limitations and assumptions

These skills are fundamental to spatial analysis and transferable to many other applications beyond wildlife habitat modeling.
